<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>VIP Veiling</title>
  <style>
    :root{
      --red:#b30000;--bg1:#0b0b0b;--bg2:#161616;--line:rgba(140,0,0,.45);
      --muted:#9a9a9a;--ok:#00c36a;--err:#ff4d4d;
    }
    body{margin:0;font-family:system-ui,Arial;color:#e8e8e8}
    .wrap{max-width:720px;margin:0 auto;padding:12px}
    .card{
      background:linear-gradient(145deg,var(--bg1),var(--bg2));
      border:1px solid var(--line);
      border-radius:14px;
      padding:18px;
      margin:14px 0;
      box-shadow:0 0 20px rgba(0,0,0,0.8),0 0 6px rgba(120,0,0,0.25);
    }
    .big{font-size:1.6rem;font-weight:700;color:var(--red)}
    .muted{color:var(--muted)}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .col{flex:1;min-width:220px}
    input,select{
      width:100%;
      padding:10px;
      border-radius:8px;
      border:1px solid #333;
      background:#121212;
      color:#fff;
      box-sizing:border-box;
    }
    input:focus,select:focus{outline:none;border-color:#990000;box-shadow:0 0 6px rgba(120,0,0,0.4);}
    button{
      margin-top:16px;
      padding:12px 18px;
      border-radius:8px;
      border:none;
      cursor:pointer;
      background:linear-gradient(145deg,#7a0000,var(--red));
      color:#fff;
      font-weight:600
    }
    button:disabled{
      opacity:.55;
      cursor:not-allowed;
      filter:saturate(.7);
    }
    .msg{margin-top:10px}
    .msg.ok{color:var(--ok)}
    .msg.err{color:var(--err)}
    .top10item{padding:6px 0;border-bottom:1px dashed rgba(120,0,0,.2)}
    h3,h4{color:var(--red);margin:0 0 10px 0}
    label{display:block;margin:10px 0 6px}
    @media (max-width:600px){.row{flex-direction:column}.col{min-width:100%}}
  </style>
</head>
<body>
<div class="wrap">

  <!-- Status -->
  <div class="card">
    <div class="big">Huidig hoogste bod: <span id="highestBid">â€¦</span></div>
    <div class="muted" style="margin-top:6px">
      Minimale verhoging: â‚¬<span id="minInc">â€¦</span> â€¢ Minimaal bod: <span id="requiredMin">â€¦</span>
    </div>
    <div class="muted" style="margin-top:6px" id="lastUpdated"></div>
    <div class="muted" style="margin-top:6px" id="endsInfo"></div>
  </div>

  <!-- Formulier + selectie -->
  <div class="card">
    <h3>Plaats je bod</h3>

    <form id="bidForm" method="POST">
      <label>Kies speelavond:</label>
      <select id="auctionSelect" name="auction"></select>

      <div class="row">
        <div class="col">
          <label>Voornaam</label>
          <input name="firstName" required autocomplete="given-name">
        </div>
        <div class="col">
          <label>Achternaam</label>
          <input name="lastName" required autocomplete="family-name">
        </div>
      </div>

      <div class="row">
        <div class="col">
          <label>E-mail</label>
          <input name="email" type="email" required autocomplete="email">
        </div>
        <div class="col">
          <label>Telefoon</label>
          <input name="phone" required autocomplete="tel">
        </div>
      </div>

      <label>Bod (euro)</label>
      <input id="bid" name="bid" type="number" min="50" step="1" required>

      <button id="submitBtn" type="submit">Bod plaatsen</button>
      <div id="msg" class="msg"></div>
    </form>

    <div style="margin-top:16px">
      <h4>Top 10 biedingen</h4>
      <div id="top10" class="muted">Ladenâ€¦</div>
    </div>
  </div>

</div>

<!-- hidden iframe target for POST -->
<iframe name="postTarget" style="display:none"></iframe>

<script>
(() => {
  const API_URL = "https://script.google.com/macros/s/AKfycbwRTvLnHQ2OJSW9zL0oxDM_626WapLjAGhEQYzdJVpwWG2JPNNMCXjDHyp_xmq8Rlfb7A/exec";
  const START_BID = 50;

  const AUCTIONS = [
    {id:"2027-01-22", label:"Vrijdag 22-01-2027", enabled:true},
    {id:"2027-01-23", label:"Zaterdag 23-01-2027", enabled:true},
    {id:"2027-01-24", label:"Zondag 24-01-2027", enabled:true},
    {id:"2027-01-29", label:"Vrijdag 29-01-2027", enabled:true},
    {id:"2027-01-30", label:"Zaterdag 30-01-2027", enabled:true}
  ];
  // ðŸ‘‰ Later een avond weghalen? Zet enabled:false of verwijder de regel.

  const $ = (id) => document.getElementById(id);
  const euro = (n) => "â‚¬" + (Number(n) || 0).toLocaleString("nl-NL");
  const esc = (s) => String(s).replace(/[&<>"']/g, m => ({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
  }[m]));

  const select = $("auctionSelect");
  const highestBidEl = $("highestBid");
  const minIncEl = $("minInc");
  const requiredMinEl = $("requiredMin");
  const lastUpdatedEl = $("lastUpdated");
  const endsInfoEl = $("endsInfo");
  const top10El = $("top10");

  const form = $("bidForm");
  const msgEl = $("msg");
  const bidInput = $("bid");
  const submitBtn = $("submitBtn");

  let highest = 0;
  let minInc = 5;

  // Dropdown vullen
  AUCTIONS.filter(a => a.enabled).forEach(a => {
    const opt = document.createElement("option");
    opt.value = a.id;
    opt.textContent = a.label;
    select.appendChild(opt);
  });

  function setMsg(t, k){
    msgEl.textContent = t || "";
    msgEl.className = "msg " + (k || "");
  }

  function jsonp(url){
    return new Promise((resolve, reject) => {
      const cb = "cb_" + Date.now() + "_" + Math.floor(Math.random()*1e6);
      window[cb] = (data) => {
        try { delete window[cb]; } catch {}
        script.remove();
        resolve(data);
      };
      const script = document.createElement("script");
      script.src = url + (url.includes("?") ? "&" : "?") + "callback=" + cb;
      script.onerror = () => {
        try { delete window[cb]; } catch {}
        script.remove();
        reject(new Error("JSONP laden mislukt"));
      };
      document.head.appendChild(script);
    });
  }

  async function refresh(){
    try{
      const auction = select.value;
      const data = await jsonp(API_URL + "?auction=" + encodeURIComponent(auction));

      if(!data || !data.ok) throw new Error(data && data.error ? data.error : "Kon data niet laden");

      highest = Number(data.highestBid) || 0;
      minInc  = Number(data.minIncrement) || 5;

      const requiredMin = Number(data.requiredMin) || (highest > 0 ? highest + minInc : START_BID);

      if (highest > 0) {
        highestBidEl.textContent = euro(highest);
      } else {
        highestBidEl.textContent = "â‚¬" + START_BID + " (startbod)";
      }

      minIncEl.textContent = minInc;
      requiredMinEl.textContent = euro(requiredMin);
      bidInput.min = String(requiredMin);

      lastUpdatedEl.textContent = "Laatst bijgewerkt: " + new Date().toLocaleString("nl-NL");

      // âœ… Cruciaal voor countdown: sla endsAt op in dataset
      if (data.endsAt) {
        endsInfoEl.dataset.endsAt = data.endsAt;
        // (optioneel) toon ook de absolute sluit-tijd als het nog lang duurt
        // endsInfoEl.textContent = "Veiling sluit om: " + new Date(data.endsAt).toLocaleString("nl-NL");
      } else {
        delete endsInfoEl.dataset.endsAt;
        endsInfoEl.textContent = "";
      }

      // Formulier (weer) aanzetten als veiling open is
      if (submitBtn) submitBtn.disabled = false;

      if(Array.isArray(data.top10) && data.top10.length){
        top10El.innerHTML = data.top10.map(it =>
          `<div class="top10item">${esc(it.date || "")} - ${esc(it.name || "â€”")} - ${euro(it.bid)}</div>`
        ).join("");
      } else {
        top10El.innerHTML = "Nog geen biedingen.";
      }

      // clear only load errors
      if (msgEl.classList.contains("err") && msgEl.textContent.startsWith("Fout bij laden")) {
        setMsg("", "");
      }
    } catch(e) {
      setMsg("Fout bij laden: " + e.message, "err");
      top10El.textContent = "Kon top 10 niet laden.";
    }
  }

  // POST via hidden iframe (geen CORS)
  form.action = API_URL;
  form.target = "postTarget";

  form.addEventListener("submit", (e) => {
    e.preventDefault();

    if (submitBtn && submitBtn.disabled) {
      setMsg("Veiling is gesloten.", "err");
      return;
    }

    const bid = Number(bidInput.value);
    const requiredMin = Number(bidInput.min) || START_BID;

    if (!Number.isFinite(bid) || bid < requiredMin) {
      setMsg("Te laag bod. Minimaal: " + euro(requiredMin), "err");
      return;
    }

    setMsg("Bod wordt verzondenâ€¦", "");
    form.submit();

    setTimeout(async () => {
      await refresh();
      setMsg("âœ… Bod geplaatst!", "ok");
      form.reset();
    }, 1000);
  });

  // Als je van avond wisselt: direct refreshen
  select.addEventListener("change", async () => {
    await refresh();
  });

  refresh();

  // âœ… Countdown elke seconde (zonder extra API-calls)
  setInterval(() => {
    if (!endsInfoEl) return;
    const iso = endsInfoEl.dataset.endsAt;
    if (!iso) return;

    const endMs = new Date(iso).getTime();
    const nowMs = Date.now();
    let diff = Math.floor((endMs - nowMs) / 1000);

    if (diff <= 0) {
      endsInfoEl.textContent = "Veiling is gesloten.";
      if (submitBtn) submitBtn.disabled = true;
      return;
    }

    // days / hours / mins / secs
    const days = Math.floor(diff / 86400);
    diff -= days * 86400;
    const hours = Math.floor(diff / 3600);
    diff -= hours * 3600;
    const mins = Math.floor(diff / 60);
    const secs = diff % 60;

    const parts = [];
    if (days) parts.push(days + " dag" + (days === 1 ? "" : "en"));
    if (hours) parts.push(hours + " uur");
    parts.push(mins + " min");
    parts.push(String(secs).padStart(2, "0") + " sec");

    endsInfoEl.textContent = "Veiling sluit over: " + parts.join(" ");
  }, 1000);

  setInterval(refresh, 15000);
})();
</script>
</body>
</html>


