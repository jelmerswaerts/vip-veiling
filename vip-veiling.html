<!doctype html>
<html lang="nl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>VIP Veiling</title>

<style>
:root{
  --red:#b30000;
  --bg:#000;
  --card1:#0b0b0b;
  --card2:#161616;
  --line:rgba(140,0,0,.45);
  --muted:#9a9a9a;
  --ok:#00c36a;
  --err:#ff4d4d;
}

*{box-sizing:border-box}
body{
  margin:0;
  font-family:system-ui,Arial;
  background:var(--bg);
  color:#e8e8e8;
}
.wrap{
  max-width:720px;
  margin:0 auto;
  padding:16px;
}
.card{
  background:linear-gradient(145deg,var(--card1),var(--card2));
  border:1px solid var(--line);
  border-radius:14px;
  padding:18px;
  margin:14px 0;
  box-shadow:0 0 22px rgba(0,0,0,.75), 0 0 10px rgba(179,0,0,.08);
  transition:transform .15s ease, box-shadow .15s ease;
}
.card:hover{
  transform:translateY(-1px);
  box-shadow:0 0 26px rgba(0,0,0,.78), 0 0 14px rgba(179,0,0,.12);
}
.big{
  font-size:1.55rem;
  font-weight:750;
  color:var(--red);
  letter-spacing:.2px;
}
.muted{color:var(--muted)}
.metaLine{
  margin-top:8px;
  line-height:1.5;
}
label{
  display:block;
  margin:12px 0 6px;
  color:#e8e8e8;
}
input,select{
  width:100%;
  padding:10px 12px;
  border-radius:10px;
  border:1px solid #2f2f2f;
  background:#121212;
  color:#fff;
}
input:focus,select:focus{
  outline:none;
  border-color:#990000;
  box-shadow:0 0 0 3px rgba(179,0,0,.18);
}
.row{
  display:flex;
  gap:12px;
  flex-wrap:wrap;
}
.col{
  flex:1;
  min-width:220px;
}
button{
  margin-top:14px;
  width:100%;
  padding:12px 16px;
  border-radius:10px;
  border:none;
  cursor:pointer;
  color:#fff;
  font-weight:700;
  background:linear-gradient(145deg,#7a0000,var(--red));
  transition:transform .08s ease, filter .15s ease, box-shadow .15s ease;
  box-shadow:0 6px 18px rgba(179,0,0,.18);
}
button:hover{
  filter:brightness(1.05);
  box-shadow:0 8px 22px rgba(179,0,0,.22);
}
button:active{transform:translateY(1px)}
button:disabled{
  opacity:.55;
  cursor:not-allowed;
  filter:saturate(.6);
  box-shadow:none;
}

.voorwaarden{
  font-size:.85rem;
  margin-top:10px;
  color:var(--muted);
  line-height:1.45;
  text-align:center;
}
.voorwaarden a{
  color:var(--red);
  text-decoration:none;
  font-weight:700;
}
.voorwaarden a:hover{text-decoration:underline}

.msg{
  margin-top:10px;
  padding:10px 12px;
  border-radius:10px;
  background:rgba(255,255,255,.03);
  border:1px solid rgba(255,255,255,.06);
  opacity:0;
  transform:translateY(4px);
  transition:opacity .18s ease, transform .18s ease;
}
.msg.show{opacity:1; transform:translateY(0)}
.msg.ok{border-color:rgba(0,195,106,.35); color:var(--ok)}
.msg.err{border-color:rgba(255,77,77,.35); color:var(--err)}

.top10item{
  padding:7px 0;
  border-bottom:1px dashed rgba(120,0,0,.22);
}

.badge{
  display:inline-block;
  padding:6px 10px;
  border-radius:999px;
  font-size:.85rem;
  border:1px solid rgba(179,0,0,.35);
  background:rgba(179,0,0,.08);
  color:#ffd7d7;
  margin-top:8px;
}

/* Popup */
.popup{
  display:none;
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.82);
  align-items:center;
  justify-content:center;
  padding:16px;
}
.popup-content{
  width:100%;
  max-width:440px;
  background:#111;
  border:1px solid rgba(179,0,0,.35);
  border-radius:14px;
  padding:18px;
  box-shadow:0 18px 60px rgba(0,0,0,.75);
}
.popup h3{
  margin:0 0 8px;
  color:var(--red);
}
.popup p{margin:8px 0; color:#ddd; line-height:1.5}
.popup .summary{
  margin-top:10px;
  padding:12px;
  border-radius:12px;
  border:1px solid rgba(255,255,255,.08);
  background:rgba(255,255,255,.03);
  color:#eee;
}
.popup .summary .line{margin:6px 0}
.popup .btnRow{
  display:flex;
  gap:10px;
  margin-top:14px;
}
.popup .btnRow button{
  width:100%;
  margin-top:0;
}
.popup .btnGhost{
  background:#2a2a2a;
  box-shadow:none;
}
.popup .btnGhost:hover{filter:brightness(1.08)}

@media (max-width:600px){
  .wrap{padding:12px}
  .row{flex-direction:column}
  .col{min-width:100%}
  .big{font-size:1.35rem}
}
</style>
</head>

<body>
<div class="wrap">

  <!-- Status -->
  <div class="card">
    <div class="big">Huidig hoogste bod: <span id="highestBid">…</span></div>

    <div class="metaLine muted">
      Minimale verhoging: €<span id="minInc">…</span> •
      Minimaal bod: <span id="requiredMin">…</span>
    </div>

    <div class="badge" id="countdown">Veiling sluit: …</div>
    <div class="muted" style="margin-top:10px" id="lastUpdated"></div>
  </div>

  <!-- Formulier -->
  <div class="card">
    <h3 style="margin:0 0 12px;color:var(--red)">Plaats je bod</h3>

    <form id="bidForm" method="POST" target="postTarget">
      <label>Kies speelavond:</label>
      <select id="auctionSelect" name="auction"></select>

      <div class="row">
        <div class="col">
          <label>Voornaam</label>
          <input id="firstName" name="firstName" required autocomplete="given-name">
        </div>
        <div class="col">
          <label>Achternaam</label>
          <input id="lastName" name="lastName" required autocomplete="family-name">
        </div>
      </div>

      <div class="row">
        <div class="col">
          <label>E-mail</label>
          <input id="email" name="email" type="email" required autocomplete="email">
        </div>
        <div class="col">
          <label>Telefoon</label>
          <input id="phone" name="phone" required autocomplete="tel">
        </div>
      </div>

      <label>Bod (euro)</label>
      <input id="bid" name="bid" type="number" min="50" step="1" required>

      <button id="submitBtn" type="submit">Bod plaatsen</button>

      <div class="voorwaarden">
        Door op <strong>“Bod plaatsen”</strong> te klikken gaat u akkoord met onze
        <a href="https://www.toneelvereniginglely.nl/algemene-voorwaarden" target="_blank" rel="noopener">
          algemene voorwaarden
        </a>
        en begrijpt u dat uw bod bindend is.
      </div>

      <div id="msg" class="msg"></div>
    </form>

    <div style="margin-top:18px">
      <h4 style="margin:0 0 8px;color:var(--red)">Top 10 biedingen</h4>
      <div id="top10" class="muted">Laden…</div>
    </div>
  </div>

</div>

<iframe name="postTarget" style="display:none"></iframe>

<!-- Popup -->
<div id="confirmPopup" class="popup" aria-hidden="true">
  <div class="popup-content" role="dialog" aria-modal="true" aria-labelledby="popTitle">
    <h3 id="popTitle">Bevestig je bod</h3>
    <p>Je staat op het punt een <strong>bindend bod</strong> te plaatsen. Dit bod kan niet worden ingetrokken.</p>

    <div class="summary">
      <div class="line"><span class="muted">Voorstelling:</span> <strong id="popAuction">—</strong></div>
      <div class="line"><span class="muted">Bod:</span> <strong id="popBid">—</strong></div>
    </div>

    <div class="btnRow">
      <button id="popConfirmBtn" type="button" onclick="confirmBid()">Ja, plaats bod</button>
      <button type="button" class="btnGhost" onclick="closePopup()">Annuleren</button>
    </div>
  </div>
</div>

<script>
(() => {
  const API_URL = "https://script.google.com/macros/s/AKfycbzBFpWNS0S5qsmwqNGL8VL-VeMw7CzFZcBCwhiE-R7icuoUTunuXtwJJHAcQGdoL5V6/exec";
  const START_BID = 50;

  const AUCTIONS = [
    {id:"2027-01-22", label:"Vrijdag 22 januari 2027", enabled:true},
    {id:"2027-01-23", label:"Zaterdag 23 januari 2027", enabled:true},
    {id:"2027-01-24", label:"Zondag 24 januari 2027", enabled:true},
    {id:"2027-01-29", label:"Vrijdag 29 januari 2027", enabled:true},
    {id:"2027-01-30", label:"Zaterdag 30 januari 2027", enabled:true},
  ];

  const $ = id => document.getElementById(id);
  const euro = n => "€" + (Number(n)||0).toLocaleString("nl-NL");

  let highest = 0;
  let minInc = 5;
  let endsAtIso = "";

  const select = $("auctionSelect");
  const bidInput = $("bid");
  const msgEl = $("msg");
  const submitBtn = $("submitBtn");
  const form = $("bidForm");

  const popup = $("confirmPopup");
  const popAuction = $("popAuction");
  const popBid = $("popBid");
  const popConfirmBtn = $("popConfirmBtn");

  function setMsg(text, type){
    msgEl.textContent = text || "";
    msgEl.className = "msg " + (type || "");
    if (text) msgEl.classList.add("show"); else msgEl.classList.remove("show");
  }

  // JSONP helper (CORS-proof)
  function jsonp(url){
    return new Promise((resolve, reject) => {
      const cb = "cb_" + Date.now() + "_" + Math.floor(Math.random()*1e6);
      window[cb] = (data) => {
        try { delete window[cb]; } catch {}
        script.remove();
        resolve(data);
      };
      const script = document.createElement("script");
      script.src = url + (url.includes("?") ? "&" : "?") + "callback=" + cb;
      script.onerror = () => {
        try { delete window[cb]; } catch {}
        script.remove();
        reject(new Error("Kon data niet laden."));
      };
      document.head.appendChild(script);
    });
  }

  // Dropdown vullen
  AUCTIONS.filter(a => a.enabled).forEach(a => {
    const opt = document.createElement("option");
    opt.value = a.id;
    opt.textContent = a.label;
    select.appendChild(opt);
  });
  if (!select.value && select.options.length) select.selectedIndex = 0;

  // POST target
  form.action = API_URL;

  async function refresh(){
    try{
      const auction = select.value;
      const data = await jsonp(API_URL + "?auction=" + encodeURIComponent(auction));

      if (!data || !data.ok) throw new Error(data && data.error ? data.error : "Kon data niet laden");

      highest = Number(data.highestBid) || 0;
      minInc  = Number(data.minIncrement) || 5;

      const requiredMin = Number(data.requiredMin) || (highest > 0 ? highest + minInc : START_BID);

      $("highestBid").textContent = highest ? euro(highest) : (euro(START_BID) + " (startbod)");
      $("minInc").textContent = minInc;
      $("requiredMin").textContent = euro(requiredMin);
      bidInput.min = String(requiredMin);

      $("lastUpdated").textContent = "Laatst bijgewerkt: " + new Date().toLocaleString("nl-NL");

      // endsAt + gesloten?
      endsAtIso = data.endsAt || "";
      if (data.closed) {
        submitBtn.disabled = true;
        setMsg("Veiling is gesloten.", "err");
      } else {
        submitBtn.disabled = false;
        if (msgEl.classList.contains("err") && msgEl.textContent.startsWith("Fout bij laden")) setMsg("", "");
      }

      if (Array.isArray(data.top10) && data.top10.length){
        $("top10").innerHTML = data.top10.map(r =>
          `<div class="top10item">${r.date} - ${r.name} - ${euro(r.bid)}</div>`
        ).join("");
      } else {
        $("top10").textContent = "Nog geen biedingen.";
      }
    } catch(e){
      setMsg("Fout bij laden: " + e.message, "err");
    }
  }

  function tickCountdown(){
    const el = $("countdown");
    if (!endsAtIso){
      el.textContent = "Veiling sluit: …";
      return;
    }
    const end = new Date(endsAtIso).getTime();
    const now = Date.now();
    let diff = Math.floor((end - now) / 1000);

    if (diff <= 0){
      el.textContent = "Veiling is gesloten.";
      submitBtn.disabled = true;
      return;
    }

    const d = Math.floor(diff / 86400); diff -= d * 86400;
    const h = Math.floor(diff / 3600);  diff -= h * 3600;
    const m = Math.floor(diff / 60);
    const s = diff % 60;

    const parts = [];
    if (d) parts.push(d + " dag" + (d === 1 ? "" : "en"));
    if (h) parts.push(h + " uur");
    parts.push(m + " min");
    parts.push(String(s).padStart(2, "0") + " sec");

    el.textContent = "Veiling sluit over: " + parts.join(" ");
  }

  function openPopupSummary(){
    const auctionLabel = select.options[select.selectedIndex]?.textContent || select.value || "—";
    const bid = Number(bidInput.value);
    popAuction.textContent = auctionLabel;
    popBid.textContent = euro(bid);

    popup.style.display = "flex";
    popup.setAttribute("aria-hidden","false");

    // focus naar de bevestigknop
    setTimeout(() => popConfirmBtn.focus(), 0);
  }

  function closePopupInternal(){
    popup.style.display = "none";
    popup.setAttribute("aria-hidden","true");
  }

  // Submit (open popup)
  form.addEventListener("submit", (e) => {
    e.preventDefault();
    setMsg("", "");

    if (submitBtn.disabled){
      setMsg("Veiling is gesloten.", "err");
      return;
    }

    const bid = Number(bidInput.value);
    const min = Number(bidInput.min) || START_BID;

    if (!Number.isFinite(bid) || bid < min){
      setMsg("Te laag bod. Minimaal: " + euro(min), "err");
      return;
    }

    openPopupSummary();
  });

  // wisselen van avond
  select.addEventListener("change", async () => {
    setMsg("", "");
    await refresh();
  });

  // Klik buiten popup-content sluit popup
  popup.addEventListener("click", (e) => {
    if (e.target === popup) closePopupInternal();
  });

  // Escape sluit popup
  document.addEventListener("keydown", (e) => {
    if (e.key === "Escape" && popup.style.display === "flex") closePopupInternal();
  });

  // Expose for onclick
  window.closePopup = function(){ closePopupInternal(); };

  window.confirmBid = function(){
    closePopupInternal();
    setMsg("Bod wordt verzonden…", "");

    // POST via iframe (CORS-proof)
    form.submit();

    setTimeout(async () => {
      await refresh();

      const keepAuction = select.value;
      form.reset();
      select.value = keepAuction;

      setMsg("✅ Bod geplaatst!", "ok");
    }, 1200);
  };

  refresh();
  setInterval(refresh, 15000);
  tickCountdown();
  setInterval(tickCountdown, 1000);
})();
</script>
</body>
</html>

